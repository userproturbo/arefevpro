generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  login         String         @unique
  nickname      String?
  email         String?        @unique
  passwordHash  String
  role          UserRole       @default(USER)
  status        UserStatus     @default(ACTIVE)
  bannedAt      DateTime?
  banReason     String?
  lastSeenAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  comments      Comment[]
  commentLikes  CommentLike[]
  likes         Like[]
  photoLikes    PhotoLike[]
  photoComments PhotoComment[]
  photoCommentLikes PhotoCommentLike[]
  videoLikes    VideoLike[]
  videoComments VideoComment[]
  videoCommentLikes VideoCommentLike[]
  notifications Notification[]
  visits        Visit[]

  @@index([status])
  @@index([lastSeenAt])
}

model Post {
  id           Int      @id @default(autoincrement())
  slug         String   @unique
  title        String
  type         PostType
  text         String?
  content      Json?
  coverImage   String?  // legacy: read-only during soft migration
  mediaUrl     String?  // legacy: read-only during soft migration
  mediaId      Int?
  media        Media?   @relation("PostMedia", fields: [mediaId], references: [id])
  coverMediaId Int?
  coverMedia   Media?   @relation("PostCover", fields: [coverMediaId], references: [id])
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  comments     Comment[]
  likes        Like[]

  @@index([mediaId])
  @@index([coverMediaId])
}

model Comment {
  id        Int           @id @default(autoincrement())
  text      String
  postId    Int
  userId    Int
  parentId  Int?
  createdAt DateTime      @default(now())
  deletedAt DateTime?
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]     @relation("CommentReplies")
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])
  likes     CommentLike[]

  @@index([postId, parentId])
  @@index([parentId])
}

model Notification {
  id        String           @id @default(cuid())
  userId    Int
  type      NotificationType
  data      Json
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([userId, readAt])
}

model Like {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Album {
  id           Int      @id @default(autoincrement())
  title        String
  slug         String   @unique
  description  String?
  published    Boolean  @default(false)
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  coverPhotoId Int?     @unique
  coverPhoto   Photo?   @relation("AlbumCoverPhoto", fields: [coverPhotoId], references: [id])
  photos       Photo[]  @relation("AlbumPhotos")
}


model Photo {
  id         Int      @id @default(autoincrement())
  albumId    Int
  storageKey String?  // legacy: read-only during soft migration
  url        String?  // legacy: read-only during soft migration
  mediaId    Int
  media      Media    @relation("PhotoMedia", fields: [mediaId], references: [id])
  width      Int?
  height     Int?
  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  order      Int      @default(0)
  updatedAt  DateTime @updatedAt
  coverFor   Album?   @relation("AlbumCoverPhoto")
  album      Album    @relation("AlbumPhotos", fields: [albumId], references: [id], onDelete: Cascade)
  likes      PhotoLike[]
  comments   PhotoComment[]

  @@index([albumId])
  @@index([mediaId])
}

model PhotoLike {
  id        Int      @id @default(autoincrement())
  photoId   Int
  userId    Int
  createdAt DateTime @default(now())

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId])
  @@index([photoId])
  @@index([userId])
}

model PhotoComment {
  id        Int       @id @default(autoincrement())
  photoId   Int
  userId    Int
  parentId  Int?
  text      String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  photo   Photo         @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  PhotoComment? @relation("PhotoCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies PhotoComment[] @relation("PhotoCommentReplies")
  likes   PhotoCommentLike[]

  @@index([photoId])
  @@index([userId])
  @@index([parentId])
}

model PhotoCommentLike {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  createdAt DateTime @default(now())

  comment PhotoComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Video {
  id               Int      @id @default(autoincrement())
  title            String
  description      String?
  thumbnailUrl     String?  // legacy: read-only during soft migration
  videoUrl         String?  // legacy: read-only during soft migration
  mediaId          Int?
  media            Media?   @relation("VideoMedia", fields: [mediaId], references: [id])
  thumbnailMediaId Int?
  thumbnailMedia   Media?   @relation("VideoThumbnail", fields: [thumbnailMediaId], references: [id])
  embedUrl         String?
  isPublished      Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  likes            VideoLike[]
  comments         VideoComment[]

  @@index([mediaId])
  @@index([thumbnailMediaId])
}

model Media {
  id          Int       @id @default(autoincrement())
  type        MediaType
  url         String
  storageKey  String
  mimeType    String?
  sizeBytes   Int?
  width       Int?
  height      Int?
  durationSec Int?
  alt         String?
  caption     String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  photos      Photo[]   @relation("PhotoMedia")
  videos      Video[]   @relation("VideoMedia")
  thumbnails  Video[]   @relation("VideoThumbnail")
  postMedia   Post[]    @relation("PostMedia")
  postCovers  Post[]    @relation("PostCover")
}

model VideoLike {
  id        Int      @id @default(autoincrement())
  videoId   Int
  userId    Int
  createdAt DateTime @default(now())

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([videoId])
  @@index([userId])
}

model VideoComment {
  id        Int      @id @default(autoincrement())
  videoId   Int
  userId    Int
  parentId  Int?
  text      String
  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video   Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  VideoComment? @relation("VideoCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies VideoComment[] @relation("VideoCommentReplies")
  likes   VideoCommentLike[]

  @@index([videoId, parentId])
  @@index([parentId])
}

model VideoCommentLike {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  createdAt DateTime @default(now())

  comment VideoComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Visitor {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  visits    Visit[]
}

model Visit {
  id        String   @id @default(uuid())
  visitorId String
  userId    Int?
  path      String?
  createdAt DateTime @default(now())
  visitor   Visitor  @relation(fields: [visitorId], references: [id])
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([visitorId])
  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

enum PostType {
  ABOUT
  PHOTO
  VIDEO
  MUSIC
  BLOG
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BANNED
}

enum NotificationType {
  COMMENT_REPLY
  PHOTO_COMMENT_REPLY
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
}
